datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String?
  image             String?
  password          String? // if using credentials login
  provider          String?
  githubAccessToken String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  subscription Subscription?
  contracts    Contract[]
}

model Contract {
  id           String       @id @default(cuid())
  title        String
  description  String?
  contractType ContractType
  code         String?

  idl       Json? // auto-generated IDL
  clientSdk Json? // auto-generated client (TS/JS)

  summary String? // AI-generated human-readable summary

  deployed  Boolean  @default(false)
  programId String? // Solana program ID after deployment
  version   Int      @default(1)
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deployments Deployment[]
  messages    Message[]
}

model Deployment {
  id          String   @id @default(cuid())
  contract    Contract @relation(fields: [contractId], references: [id])
  contractId  String
  network     String // devnet/testnet/mainnet
  deployedAt  DateTime @default(now())
  txSignature String? // optional Solana transaction signature
  status      String // pending/success/failure

  @@index([contractId])
}

model Message {
  id         String   @id @default(cuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])

  role    ChatRole
  content String   @db.Text

  planning       Boolean @default(false)
  generatingCode Boolean @default(false)
  building       Boolean @default(false)
  creatingFiles  Boolean @default(false)
  finalzing      Boolean @default(false)
  error          Boolean @default(false)

  // isCodeBuilt Boolean? @default(false)
  // buildStatus

  createdAt DateTime @default(now())

  @@index([contractId])
}

model Subscription {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  plan   PlanType           @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?

  start     DateTime  @default(now())
  end       DateTime?
  autoRenew Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ContractType {
  TOKEN
  NFT
  STAKING
  DAO
  DEFI
  MARKETPLACE
  CUSTOM
}

enum Network {
  DEVNET
  TESTNET
  MAINNET_BETA
}

enum DeploymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum ChatRole {
  USER
  AI
  SYSTEM
}

enum PlanType {
  FREE
  PREMIUM
  PREMIUM_PLUS
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

enum SystemMessageType {
  BUILD_START
  BUILD_PROGRESS
  BUILD_COMPLETE
  BUILD_ERROR
}

// user message - prompt
// ai message - start context
// system message - card content
// ai message -> llm_response

// user message - prompt
// ai message - start context
// system message - card content
// ai message -> llm_response

// user message - prompt
// ai message - start context
// system message - card content
// ai message -> llm_response

// user message - prompt
// user message - prompt
// user message - prompt
// ai message - 
// user message - prompt
enum ContractGenerationPhase {
  PLANNING
  GENERATING_CODE
  BUILDING
  CREATING_FILES
  FINALIZING
}
